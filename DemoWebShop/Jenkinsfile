pipeline {
    agent any

    options {
        timestamps()
    }

    environment {
        VENV_DIR = 'venv'
        TEST_REPORT = 'report.html'
    }

    stages {

        stage('Set up Python venv (Windows)') {
            steps {
                powershell '''
                    $ErrorActionPreference = "Stop"

                    python --version

                    if (!(Test-Path ".\\$env:VENV_DIR")) {
                        python -m venv "$env:VENV_DIR"
                    }

                    . ".\\$env:VENV_DIR\\Scripts\\Activate.ps1"

                    python -m pip install --upgrade pip

                    if (Test-Path "requirements.txt") {
                        pip install -r requirements.txt
                    }

                    pip install playwright
                    python -m playwright install
                '''
            }
        }

        stage('Run Tests') {
            steps {
                powershell '''
                    $ErrorActionPreference = "Stop"
                    . ".\\$env:VENV_DIR\\Scripts\\Activate.ps1"

                    pytest --html="$env:TEST_REPORT" --self-contained-html
                '''
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: 'report.html', allowEmptyArchive: true
        }
    }
}

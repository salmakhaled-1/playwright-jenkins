
pipeline {
    agent any

    options {
        timestamps()               // keep timestamps
        // skipDefaultCheckout(true) // keep commented unless you add a manual checkout
    }

    environment {
        VENV_DIR    = 'venv'
        TEST_REPORT = 'report.html'
    }

    stages {
        stage('Checkout') {
            steps {
                git url: 'https://github.com/salmakhaled-1/playwright-jenkins.git', branch: 'main'
            }
        }

        stage('Set up Python venv (Windows)') {
            steps {
                powershell '''
                    $ErrorActionPreference = "Stop"

                    python --version

                    if (!(Test-Path ".\\\\${env:VENV_DIR}")) {
                        python -m venv "${env:VENV_DIR}"
                    }

                    . ".\\\\${env:VENV_DIR}\\\\Scripts\\\\Activate.ps1"
                    python -m pip install --upgrade pip

                    if (Test-Path ".\\\\requirements.txt") {
                        pip install -r requirements.txt
                    } else {
                        Write-Host "requirements.txt not found â€“ skipping"
                    }

                    pip install playwright
                    python -m playwright install --with-deps
                '''
            }
        }

        stage('Run Tests') {
            steps {
                powershell '''
                    $ErrorActionPreference = "Stop"
                    . ".\\\\${env:VENV_DIR}\\\\Scripts\\\\Activate.ps1"

                    if (!(Test-Path ".\\\\artifacts")) {
                        New-Item -ItemType Directory -Path ".\\\\artifacts" | Out-Null
                    }

                    pytest -q --maxfail=1 --disable-warnings --html="${env:TEST_REPORT}" --self-contained-html
                '''
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: 'report.html, artifacts/**', fingerprint: true, allowEmptyArchive: true
        }
        failure {
            echo 'Build failed. Check console log & archived artifacts for details.'
        }
    }
}

